generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "fullTextSearch"]
  binaryTargets   = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp")]
}

model User {
  keycloakId      String     @id
  email           String     @unique
  organizationId  String?    
  organization    External? @relation("UserOrganization", fields: [organizationId], references: [id])
  createdSet Metadata[] @relation("MetadataCreatedBy")
  updatedSet Metadata[] @relation("MetadataUpdatedBy")
  dataOwners   Metadata[] @relation("MetadataDataOwnerBy")
  actors          Actor[]    @relation("UserActors")


  @@map("user")
}

model Application {
  id                       String     @id @default(uuid())
  label                    String
  shortName                String
  logo                     String
  description              String
  url                      String
  uri                      String
  purposes                 String[]
  tags                     String[]
  lifecycleId              String // Changement d'Int à String
  lifecycle                Lifecycle           @relation("LifecycleApplications", fields: [lifecycleId], references: [id])
  metadataId               String // Changement d'Int à String
  metadata                 Metadata            @relation("ApplicationMetadata", fields: [metadataId], references: [id])
  parentId                 String? // Changement d'Int à String 
  parent                   Application?        @relation("ApplicationParent", fields: [parentId], references: [id])
  childrens                 Application[]       @relation("ApplicationParent")
  actors                   Actor[]            @relation("ApplicationActors")
  ExternalSources          External[]         @relation("ApplicationExternalSources")
  compliances              Compliance[]        @relation("ApplicationCompliances")

  @@map("application")
}

model Actor {
  id              String       @id @default(uuid())
  role            String
  userId          String
  user            User         @relation("UserActors", fields: [userId], references: [keycloakId])
  organizationId  String?      
  organization    External?   @relation("ActorOrganization", fields: [organizationId], references: [id])
  applicationId   String?      
  application     Application? @relation("ApplicationActors", fields: [applicationId], references: [id])

  @@map("actor")
}

model External {
  id              String     @id @default(uuid()) // Changement d'Int à String avec UUID
  externalSourceId    String                 
  externalSource      ExternalSource @relation("ExternalSourceExternal", fields: [externalSourceId], references: [id])
  value           String
  label           String
  shortName       String
  lastSourceUpdate  DateTime
  metadataId      String
  metadata        Metadata            @relation("ExternalsMetadata", fields: [metadataId], references: [id])
  users           User[]              @relation("UserOrganization")
  actor           Actor[]             @relation("ActorOrganization")
  applicationId   String? // Changement d'Int à String
  application     Application?        @relation("ApplicationExternalSources", fields: [applicationId], references: [id])

  @@map("external")
}

model ExternalSource {
  id             String                      @id @default(uuid())
  type           ExternalSourceType
  uri            String
  valueType      ExternalSourceValueType
  metadataId     String
  metadata       Metadata                @relation("ExternalSourcesMetadata", fields: [metadataId], references: [id])
  externals      External[]              @relation("ExternalSourceExternal")

  @@map("external_source")
}

model Compliance {
  id              String                 @id @default(uuid())
  type            ComplianceType
  name            String
  status          ComplianceStatus
  validityStart   DateTime?
  validityEnd     DateTime?
  scoreValue      String?
  scoreUnit       String?
  notes           String?
  metadataId      String?
  metadata        Metadata?            @relation("ComplianceMetadata", fields: [metadataId], references: [id])
  applicationId   String? 
  application     Application?        @relation("ApplicationCompliances", fields: [applicationId], references: [id])

  @@map("compliance")
}

model Lifecycle {
  id                          String              @id @default(uuid()) // Changement d'Int à String avec UUID
  status                      LifecycleStatus
  firstProductionDate         DateTime
  plannedDecommissioningDate  DateTime?
  metadataId                  String
  metadata                    Metadata          @relation("LifecycleMetadata", fields: [metadataId], references: [id])
  applications                Application[]     @relation("LifecycleApplications")

  @@map("lifecycle")
}

model Metadata {
  id            String          @id @default(uuid()) // Changement d'Int à String avec UUID
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  createdById   String
  createdBy     User         @relation("MetadataCreatedBy", fields: [createdById], references: [keycloakId])
  updatedById   String
  updatedBy     User         @relation("MetadataUpdatedBy", fields: [updatedById], references: [keycloakId])
  dataOwnerId       String?
  dataOwner         User?        @relation("MetadataDataOwnerBy", fields: [dataOwnerId], references: [keycloakId])
  externals      External[]  @relation("ExternalsMetadata")
  externalSources ExternalSource[] @relation("ExternalSourcesMetadata")
  applications  Application[] @relation("ApplicationMetadata") 
  lifecycle     Lifecycle[]   @relation("LifecycleMetadata")
  compliance    Compliance[] @relation("ComplianceMetadata")

  @@map("metadata")
}

enum LifecycleStatus {
  under_construction
  in_production
  decommissioned
}

enum ComplianceType {
  regulation
  standard
  policy
  contractual
  security
  privacy
}

enum ComplianceStatus {
  compliant
  non_compliant
  partially_compliant
  not_concerned
}

enum ExternalSourceType {
  organization
  application
  regulation
  financial
  population
}

enum ExternalSourceValueType {
  url
  uri
  identifier
  name
}
